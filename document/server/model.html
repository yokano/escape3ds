<!--
	Copyright 2009 The Go Authors. All rights reserved.
	Use of this source code is governed by a BSD-style
	license that can be found in the LICENSE file.
-->
<!--
	Note: Static (i.e., not template-generated) href and id
	attributes start with "pkg-" to make it impossible for
	them to conflict with generated attributes (some of which
	correspond to Go identifiers).
-->
<link hreF="../style.css" rel="stylesheet"></link>
<script src="../godocs.js"></script>

	
		<div id="short-nav">
			<dl>
			<dd><code>import "./server/model"</code></dd>
			</dl>
			<dl>
			<dd><a href="#pkg-overview" class="overviewLink">Overview</a></dd>
			<dd><a href="#pkg-index">Index</a></dd>
			
			
			
			</dl>
		</div>
		<!-- The package's Name is printed as title by the top-level template -->
		<div id="pkg-overview" class="toggleVisible">
			<div class="collapsed">
				<h2 class="toggleButton" title="Click to show Overview section">Overview ▹</h2>
			</div>
			<div class="expanded">
				<h2 class="toggleButton" title="Click to hide Overview section">Overview ▾</h2>
				<p>
datastore や blobstore などのサーバ上のデータを操作をまとめたもの。
シーン、イベント、アイテムなどゲームに関わるデータや、
仮登録ユーザ、本登録ユーザ、セッション管理などのユーザに関するデータを扱う。
</p>

			</div>
		</div>
		
	
		<h2 id="pkg-index">Index</h2>
		<!-- Table of contents for API; must be named manual-nav to turn off auto nav. -->
		<div id="manual-nav">
			<dl>
			
			
			
			
				
				<dd><a href="#Game">type Game</a></dd>
				
				
			
				
				<dd><a href="#InterimUser">type InterimUser</a></dd>
				
				
			
				
				<dd><a href="#Model">type Model</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#NewModel">func NewModel(c appengine.Context) *Model</a></dd>
				
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.AddBlob">func (this *Model) AddBlob(file multipart.File, fileHeader *multipart.FileHeader) string</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.AddGame">func (this *Model) AddGame(game *Game, encodedUserKey string) string</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.AddScene">func (this *Model) AddScene(scene *Scene, id string, encodedGameKey string) string</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.AddUser">func (this *Model) AddUser(user *User) string</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.DeleteGame">func (this *Model) DeleteGame(encodedGameKey string)</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.DeleteScene">func (this *Model) DeleteScene(id string)</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.ExistOAuthUser">func (this *Model) ExistOAuthUser(userType string, oauthId string) bool</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.GetAllUser">func (this *Model) GetAllUser() map[string]*User</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.GetBlob">func (this *Model) GetBlob(key string) (string, []byte)</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.GetGame">func (this *Model) GetGame(encodedGameKey string) *Game</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.GetGameList">func (this *Model) GetGameList(encodedUserKey string) map[string]*Game</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.GetInterimUsers">func (this *Model) GetInterimUsers() map[string]*InterimUser</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.GetScenes">func (this *Model) GetScenes(encodedGameKey string) []*Scene</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.GetUser">func (this *Model) GetUser(encodedKey string) *User</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.GetUserKey">func (this *Model) GetUserKey(params map[string]string) string</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.GetUserKeyFromSession">func (this *Model) GetUserKeyFromSession(sessionId string) string</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.InterimRegistration">func (this *Model) InterimRegistration(name string, mail string, pass string) string</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.LoginCheck">func (this *Model) LoginCheck(mail string, pass string) (string, string)</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.NewGame">func (this *Model) NewGame(params map[string]string) *Game</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.NewInterimUser">func (this *Model) NewInterimUser(name string, mail string, pass string) *InterimUser</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.NewScene">func (this *Model) NewScene(name string, background string) *Scene</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.NewUser">func (this *Model) NewUser(data map[string]string) *User</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.Registration">func (this *Model) Registration(encodedKey string)</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.RemoveSession">func (this *Model) RemoveSession(sessionId string)</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.StartSession">func (this *Model) StartSession(userKey string) string</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.SyncGame">func (this *Model) SyncGame(w http.ResponseWriter, r *http.Request, path []string)</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.SyncScene">func (this *Model) SyncScene(w http.ResponseWriter, r *http.Request, path []string)</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Model.UpdateGame">func (this *Model) UpdateGame(encodedGameKey string, game *Game)</a></dd>
				
			
				
				<dd><a href="#Scene">type Scene</a></dd>
				
				
			
				
				<dd><a href="#User">type User</a></dd>
				
				
					
					<dd>&nbsp; &nbsp; <a href="#User.HashPassword">func (this *User) HashPassword(pass string, salt string) ([]byte, string)</a></dd>
				
			
			
		</dl>

		

		
			<h4>Package files</h4>
			<p>
			<span style="font-size:90%">
			
				<a href="/target/blob.go">blob.go</a>
			
				<a href="/target/game.go">game.go</a>
			
				<a href="/target/model.go">model.go</a>
			
				<a href="/target/scene.go">scene.go</a>
			
				<a href="/target/session.go">session.go</a>
			
				<a href="/target/user.go">user.go</a>
			
			</span>
			</p>
		
	
		
		
		
		
			
			
			<h2 id="Game">type <a href="/target/game.go?s=452:744#L5">Game</a></h2>
			<pre>type Game struct {
    Name        string `json:&#34;name&#34;`        <span class="comment">// ゲーム名</span>
    Description string `json:&#34;description&#34;` <span class="comment">// ゲームの説明</span>
    Thumbnail   string `json:&#34;thumbnail&#34;`   <span class="comment">// サムネイルの画像パス</span>
    FirstScene  string `json:&#34;firstScene&#34;`  <span class="comment">// 最初のシーンのエンコード済みキー</span>
}</pre>
			<p>
ゲームオブジェクト。ゲームはそれを所有するユーザにぶら下がる形で定義される。
ゲームは自分を所有するユーザを親として参照する形で datastore に保存される。
datastore の ancestor path を参照。
<a href="https://developers.google.com/appengine/docs/go/datastore/#Ancestor_Paths">https://developers.google.com/appengine/docs/go/datastore/#Ancestor_Paths</a>
</p>


			

			

			

			

			
		
			
			
			<h2 id="InterimUser">type <a href="/target/user.go?s=2342:2471#L55">InterimUser</a></h2>
			<pre>type InterimUser struct {
    Name string <span class="comment">// ユーザ名</span>
    Mail string <span class="comment">// メールアドレス</span>
    Pass string <span class="comment">// パスワード</span>
}</pre>
			<p>
仮登録ユーザ。トップページのユーザ登録フォームに入力されたユーザデータは一時的に仮登録データベースへ保存される。
ユーザが登録したメールアドレスに借り登録完了のメールが送られ、そのなかのURLをクリックすることで、
仮登録データベースからユーザデータベースへデータが移行される。
仮登録完了から 24 時間以内にメールの URL がクリックされなかった場合は、
仮登録データベースからユーザ情報が削除され、仮登録は失敗と鳴る。
</p>


			

			

			

			

			
		
			
			
			<h2 id="Model">type <a href="/target/model.go?s=410:452#L1">Model</a></h2>
			<pre>type Model struct {
    <span class="comment">// contains filtered or unexported fields</span>
}</pre>
			<p>
アプリケーションのデータ操作を行うオブジェクト
</p>


			

			

			

			
				
				<h3 id="NewModel">func <a href="/target/model.go?s=567:608#L7">NewModel</a></h3>
				<pre>func NewModel(c appengine.Context) *Model</pre>
				<p>
モデルのインスタンスを作成する。
モデルを使う前にかならず実行すること。
</p>

				
			

			
				
				<h3 id="Model.AddBlob">func (*Model) <a href="/target/blob.go?s=377:465#L4">AddBlob</a></h3>
				<pre>func (this *Model) AddBlob(file multipart.File, fileHeader *multipart.FileHeader) string</pre>
				<p>
ファイルを blobstore に保存して blobkey を返す。
エディタから画像ファイルをアップロードするときに使う。
引数としてファイルと、ファイルの種類などを含むファイルヘッダを渡す。
</p>

				
				
			
				
				<h3 id="Model.AddGame">func (*Model) <a href="/target/game.go?s=1428:1496#L25">AddGame</a></h3>
				<pre>func (this *Model) AddGame(game *Game, encodedUserKey string) string</pre>
				<p>
データストアにゲームを追加してエンコード済みのキーを返す。
引数として追加するゲームオブジェクトと、エンコード済みユーザキーを渡す。
引数として渡したユーザキーにぶら下がる形でゲームが保存される。
</p>

				
				
			
				
				<h3 id="Model.AddScene">func (*Model) <a href="/target/scene.go?s=989:1071#L23">AddScene</a></h3>
				<pre>func (this *Model) AddScene(scene *Scene, id string, encodedGameKey string) string</pre>
				<p>
シーンをデータストアへ追加する。
シーンが追加されるのはエディタでシーンを新規作成した時だけ。
Backbone.js がモデルに対して自動的に割り振る cid をデータストアの StringID として使う。
引数として追加するシーン、cid、追加先のゲームキーを渡す。
追加に成功したらエンコード済みのシーンキーを返す
</p>

				
				
			
				
				<h3 id="Model.AddUser">func (*Model) <a href="/target/user.go?s=3656:3701#L88">AddUser</a></h3>
				<pre>func (this *Model) AddUser(user *User) string</pre>
				<p>
データストアに引数として渡したユーザを新規追加する。
追加が完了したらユーザキーを返す。
</p>

				
				
			
				
				<h3 id="Model.DeleteGame">func (*Model) <a href="/target/game.go?s=2708:2760#L59">DeleteGame</a></h3>
				<pre>func (this *Model) DeleteGame(encodedGameKey string)</pre>
				<p>
データストアから指定したキーのゲームを削除する。
削除を命令したユーザとゲームの所有者が一致していることを事前に確認すること。
この関数内ではチェックを行わない。
</p>

				
				
			
				
				<h3 id="Model.DeleteScene">func (*Model) <a href="/target/scene.go?s=1416:1457#L33">DeleteScene</a></h3>
				<pre>func (this *Model) DeleteScene(id string)</pre>
				<p>
引数として指定された id のシーンをデータストアから削除する。
</p>

				
				
			
				
				<h3 id="Model.ExistOAuthUser">func (*Model) <a href="/target/user.go?s=6849:6920#L177">ExistOAuthUser</a></h3>
				<pre>func (this *Model) ExistOAuthUser(userType string, oauthId string) bool</pre>
				<p>
指定されたOAuthユーザが既にデータベース上に存在するかどうか調べる。
存在したら true、存在しなかったら false を返す。
userType に &#34;Twitter&#34; または &#34;Facebook&#34; を指定すること。
oauthId に調べる対象の OAuthId を指定する。
</p>

				
				
			
				
				<h3 id="Model.GetAllUser">func (*Model) <a href="/target/user.go?s=8136:8184#L223">GetAllUser</a></h3>
				<pre>func (this *Model) GetAllUser() map[string]*User</pre>
				<p>
すべてのユーザを取得する
</p>

				
				
			
				
				<h3 id="Model.GetBlob">func (*Model) <a href="/target/blob.go?s=1347:1402#L36">GetBlob</a></h3>
				<pre>func (this *Model) GetBlob(key string) (string, []byte)</pre>
				<p>
blobstore に保存したファイルを読み出す。
引数として読みだすファイルの blobkey を渡す。
ファイルタイプとバイナリデータが返される。
</p>

				
				
			
				
				<h3 id="Model.GetGame">func (*Model) <a href="/target/game.go?s=1860:1915#L36">GetGame</a></h3>
				<pre>func (this *Model) GetGame(encodedGameKey string) *Game</pre>
				<p>
エンコード済みのキーを指定してデータストアからゲームを取得する。
</p>

				
				
			
				
				<h3 id="Model.GetGameList">func (*Model) <a href="/target/game.go?s=3045:3115#L69">GetGameList</a></h3>
				<pre>func (this *Model) GetGameList(encodedUserKey string) map[string]*Game</pre>
				<p>
ユーザが所有しているゲーム一覧を返す。
戻り値は、エンコード済みのゲームキーとゲームの対応表
</p>

				
				
			
				
				<h3 id="Model.GetInterimUsers">func (*Model) <a href="/target/user.go?s=7655:7715#L204">GetInterimUsers</a></h3>
				<pre>func (this *Model) GetInterimUsers() map[string]*InterimUser</pre>
				<p>
仮登録ユーザ一覧を返す
</p>

				
				
			
				
				<h3 id="Model.GetScenes">func (*Model) <a href="/target/scene.go?s=1571:1631#L38">GetScenes</a></h3>
				<pre>func (this *Model) GetScenes(encodedGameKey string) []*Scene</pre>
				<p>
引数として渡されたゲームキーにぶらさがっているシーンリストを取得する
</p>

				
				
			
				
				<h3 id="Model.GetUser">func (*Model) <a href="/target/user.go?s=5093:5144#L127">GetUser</a></h3>
				<pre>func (this *Model) GetUser(encodedKey string) *User</pre>
				<p>
引数として渡されたユーザキーのユーザをデータストアから取得する。
成功したら取得したユーザオブジェクトを返す。
</p>

				
				
			
				
				<h3 id="Model.GetUserKey">func (*Model) <a href="/target/user.go?s=7312:7374#L190">GetUserKey</a></h3>
				<pre>func (this *Model) GetUserKey(params map[string]string) string</pre>
				<p>
パラメータで指定されたユーザを探してユーザキーを返す。
存在しない場合は空文字を返す。
params には検索条件をセットする。
</p>

				
				
			
				
				<h3 id="Model.GetUserKeyFromSession">func (*Model) <a href="/target/session.go?s=1300:1365#L34">GetUserKeyFromSession</a></h3>
				<pre>func (this *Model) GetUserKeyFromSession(sessionId string) string</pre>
				<p>
memcache から指定されたセッションIDに関連づいているユーザキーを返す
該当するユーザーキーが見つからなかったら空文字を返す
</p>

				
				
			
				
				<h3 id="Model.InterimRegistration">func (*Model) <a href="/target/user.go?s=5581:5665#L143">InterimRegistration</a></h3>
				<pre>func (this *Model) InterimRegistration(name string, mail string, pass string) string</pre>
				<p>
ユーザを仮登録データベースに登録する。
仮登録されたユーザは24時間以内に本登録する。
本登録されなかった場合は24時間後に削除される。
仮登録ユーザのエンコードされたキーを返す。
</p>

				
				
			
				
				<h3 id="Model.LoginCheck">func (*Model) <a href="/target/user.go?s=4244:4316#L103">LoginCheck</a></h3>
				<pre>func (this *Model) LoginCheck(mail string, pass string) (string, string)</pre>
				<p>
引数として渡したメールアドレスとパスワードのユーザがいるか調べる。
存在した場合はユーザキーとユーザ名を返す。
存在しない場合は戻り値がすべて空文字になる。
</p>

				
				
			
				
				<h3 id="Model.NewGame">func (*Model) <a href="/target/game.go?s=902:960#L13">NewGame</a></h3>
				<pre>func (this *Model) NewGame(params map[string]string) *Game</pre>
				<p>
新しいゲームオブジェクトを作成して返す。新しく作られるゲームのパラメータを格納した map 引数として渡す。
</p>

				
				
			
				
				<h3 id="Model.NewInterimUser">func (*Model) <a href="/target/user.go?s=2667:2752#L63">NewInterimUser</a></h3>
				<pre>func (this *Model) NewInterimUser(name string, mail string, pass string) *InterimUser</pre>
				<p>
仮登録ユーザを作成する。引数としてユーザ名、メールアドレス、パスワードを渡す。
新規作成された仮登録ユーザオブジェクトを返す。
</p>

				
				
			
				
				<h3 id="Model.NewScene">func (*Model) <a href="/target/scene.go?s=401:467#L11">NewScene</a></h3>
				<pre>func (this *Model) NewScene(name string, background string) *Scene</pre>
				<p>
シーンオブジェクトを新しく作成する。
</p>

				
				
			
				
				<h3 id="Model.NewUser">func (*Model) <a href="/target/user.go?s=672:728#L14">NewUser</a></h3>
				<pre>func (this *Model) NewUser(data map[string]string) *User</pre>
				<p>
ユーザオブジェクトを作成する。
戻り値は作成したユーザ、失敗したらnil。
</p>

				
				
			
				
				<h3 id="Model.Registration">func (*Model) <a href="/target/user.go?s=5989:6039#L152">Registration</a></h3>
				<pre>func (this *Model) Registration(encodedKey string)</pre>
				<p>
仮登録ユーザキーを指定して、該当するユーザを登録する。
</p>

				
				
			
				
				<h3 id="Model.RemoveSession">func (*Model) <a href="/target/session.go?s=1000:1050#L27">RemoveSession</a></h3>
				<pre>func (this *Model) RemoveSession(sessionId string)</pre>
				<p>
memcache から指定されたセッションIDのセッション情報を削除する
</p>

				
				
			
				
				<h3 id="Model.StartSession">func (*Model) <a href="/target/session.go?s=421:475#L4">StartSession</a></h3>
				<pre>func (this *Model) StartSession(userKey string) string</pre>
				<p>
セッションを開始する。サーバの memcache 内にセッションIDとユーザキーの対応を保存している。
セッションは最後のページアクセスから24時間の有効で、24時間経過したものは cron で定期的に削除される。
関数はセッションIDを返す。
</p>

				
				
			
				
				<h3 id="Model.SyncGame">func (*Model) <a href="/target/game.go?s=3688:3770#L95">SyncGame</a></h3>
				<pre>func (this *Model) SyncGame(w http.ResponseWriter, r *http.Request, path []string)</pre>
				<p>
ゲームデータの同期。
リクエストのメソッドが CRUD に対応している。
POST:CREATE, GET:READ, PUT:UPDATE, DELETE:DELETE
</p>

				
				
			
				
				<h3 id="Model.SyncScene">func (*Model) <a href="/target/scene.go?s=2300:2383#L65">SyncScene</a></h3>
				<pre>func (this *Model) SyncScene(w http.ResponseWriter, r *http.Request, path []string)</pre>
				<p>
シーンデータの同期。
/sync/scene/[gamekey] というURLでリクエストが送られる。
リクエストのメソッドが CRUD に対応している。
POST:CREATE, GET:READ, PUT:UPDATE, DELETE:DELETE
</p>

				
				
			
				
				<h3 id="Model.UpdateGame">func (*Model) <a href="/target/game.go?s=2246:2310#L48">UpdateGame</a></h3>
				<pre>func (this *Model) UpdateGame(encodedGameKey string, game *Game)</pre>
				<p>
ゲームを更新する。引数として渡されたキー encodedGameKey のゲームを、ゲームオブジェクト game で上書きする。
</p>

				
				
			
		
			
			
			<h2 id="Scene">type <a href="/target/scene.go?s=260:341#L3">Scene</a></h2>
			<pre>type Scene struct {
    Name       string
    Background string
    Enter      string
    Leave      string
}</pre>
			<p>
シーンオブジェクト。ゲームを構成する場面を表す。
背景画像、開始時のイベント、終了時のイベントを持つ。
</p>


			

			

			

			

			
		
			
			
			<h2 id="User">type <a href="/target/user.go?s=116:560#L3">User</a></h2>
			<pre>type User struct {
    Type    string <span class="comment">// ユーザアカウントの種類 &#34;Twitter&#34;/&#34;Facebook&#34;/&#34;normal&#34;</span>
    Name    string <span class="comment">// ユーザ名</span>
    Pass    []byte <span class="comment">// ユーザの暗号化済パスワード（user_type == &#34;normal&#34;の場合のみ）</span>
    Mail    string <span class="comment">// ユーザのメールアドレス（user_type == &#34;normal&#34;の場合のみ）</span>
    Salt    string <span class="comment">// パスワードソルト</span>
    OAuthId string <span class="comment">// OAuthのサービスプロバイダが決めたユーザID</span>
}</pre>
			<p>
ユーザデータ
</p>


			

			

			

			

			
				
				<h3 id="User.HashPassword">func (*User) <a href="/target/user.go?s=3225:3298#L75">HashPassword</a></h3>
				<pre>func (this *User) HashPassword(pass string, salt string) ([]byte, string)</pre>
				<p>
ユーザのパスワードをハッシュ化する。引数として平文のパスワードと、ソルトを渡す。
引数として渡すソルトが空文字の場合は自動でランダムな文字列を作成する。
ハッシュ化が成功したら、ハッシュ化されたパスワードとソルトを返す。
ハッシュは SHA-1 を使う。
</p>

				
				
			
		
		</div>
	

	







